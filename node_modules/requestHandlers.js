const url = require('url');
const serveStatic = require("serve-static-page");
const path = require('path');

function incomingCall(res, req){
	console.log("Request handler for 'incoming-call' called");
	res.writeHead(200,{"Content-Type":"text/plain"});
	res.write("Hello World");
	res.end();
}
function serve(res,req){
	console.log("Request Handler for 'serve' called.");
	const parsedUrl = url.parse(req.url);

	//Sanitize URL.
	// see https://en.wikipedia.org/wiki/Directory_traversal_attack
	const sanitizePath = path.normalize(parsedUrl.pathname).replace(/^(\.\.[\/\\])+/, '');
	serveStatic.serve(sanitizePath, res);
}
function deny(res, req){
	console.log("page not found");
	res.writeHead(404,{"Content-Type":"text/plain"});
	res.write('Requested page not found');
	res.end()
}
function oAuthCallback(res, req){
	console.log("oAuth Callback called");
	var myURL = url.parse(req.url);
	var code = myURL.searchParams.get('code');
	var state = myURL.searchParams.get('state');
	
	console.log("Auth code is: " + code);
	console.log("Auth state is: " + state);
}
function favicon(res){

}
function certificate(res,req){
	const cert = req.socket.getPeerCertificate();
	
	//console.log(`Authorized: ${req.socket.authorized}, Subject: ${cert.subject}`);
	//console.dir(cert);
	if(req.client.authorized){
		res.statusCode = 200;
		res.write(`Hello ${cert.subject.CN}, your certificate is from ${cert.issuer.CN}!`);
		res.end();
	} else if (cert.subject){
		res.statusCode = 403;
		res.write(`Sorry, ${cert.sunject.CN}, certificates from ${cert.issuer.CN} are not welcome.`);
		res.end();
	} else {
		res.statusCode = 401;
		res.write('Please provide a client certificate');
		res.end();
	}
}
exports.incomingCall = incomingCall;
exports.deny = deny;
exports.favicon = favicon;
exports.oauth = oAuthCallback;
exports.serve = serve;
exports.cert = certificate;
